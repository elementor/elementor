# CSS Properties Atomic Widget Rebuild PRD

## 🎯 **Project Overview**

**Project Name**: CSS Properties Atomic Widget Integration  
**Version**: 2.0  
**Date**: September 23, 2025  
**Status**: Planning Phase  

### **Mission Statement**
Rebuild the CSS properties conversion system from scratch to properly integrate with Elementor's Atomic Widgets module, ensuring all generated JSON is created by actual atomic widgets and passes Elementor's validation.

---

## 🚨 **Problem Statement**

### **Current System Failures**
The existing CSS properties system creates **fake atomic widget JSON** that appears correct but is completely ignored by Elementor:

1. **Architectural Failure**: CSS Converter creates pseudo-atomic JSON directly
2. **No Atomic Widget Integration**: Bypasses actual atomic widget prop types
3. **Visual Failure**: Properties appear in JSON but don't render in editor
4. **Schema Violations**: Generated JSON fails atomic widget validation

### **Specific Broken Properties**
- `text-shadow`: Uses string type, completely non-functional
- `box-shadow`: Creates string instead of `Box_Shadow_Prop_Type` array
- `border-radius`: Uses size type instead of `Border_Radius_Prop_Type`
- `border`: Creates unrecognized nested structure
- **ALL PROPERTIES**: Generate unrecognized pseudo-atomic JSON

---

## 🎯 **Success Criteria**

### **Primary Goals**
1. **✅ Atomic Widget JSON Creation**: All JSON generated by actual atomic widgets
2. **✅ Visual Property Application**: All properties visually render in Elementor editor
3. **✅ Schema Compliance**: All JSON passes atomic widget validation
4. **✅ Proper Prop Types**: Use actual `Size_Prop_Type`, `Color_Prop_Type`, etc.

### **Technical Requirements**
- Use `Widget_Builder::make()` and `Element_Builder::make()` for JSON creation
- Integrate with `/plugins/elementor/modules/atomic-widgets/prop-types/`
- Pass atomic widget schema validation
- Support all 32+ CSS properties from original system

---

## 🏗️ **Architecture Design**

### **New Data Flow**
```
CSS Property → Atomic Widget Service → Widget_Builder → Validated JSON
```

### **Core Components**

#### **1. Atomic Widget Service**
- **File**: `services/atomic-widgets/atomic-widget-service.php`
- **Purpose**: Interface with atomic widgets module
- **Methods**:
  - `create_widget_with_props()`
  - `validate_prop_structure()`
  - `get_supported_prop_types()`

#### **2. Prop Type Mappers**
- **Directory**: `convertors/atomic-properties/`
- **Purpose**: Map CSS values to atomic prop types
- **Pattern**: One mapper per atomic prop type

#### **3. Widget JSON Generator**
- **File**: `services/atomic-widgets/widget-json-generator.php`
- **Purpose**: Use `Widget_Builder` to create final JSON
- **Integration**: Direct atomic widget module calls

---

## 📋 **Implementation Plan**

### **Phase 1: Foundation (Week 1)**
#### **Atomic Widget Integration**
- [ ] Create `services/atomic-widgets/` directory structure
- [ ] Implement `Atomic_Widget_Service` class
- [ ] Create `Widget_JSON_Generator` with `Widget_Builder` integration
- [ ] Establish connection to atomic widgets module

#### **Prop Type Research**
- [ ] Catalog all atomic prop types in `/atomic-widgets/prop-types/`
- [ ] Document expected structures for each prop type
- [ ] Create prop type validation utilities

### **Phase 2: Core Prop Types (Week 2)**
#### **Essential Prop Types**
- [ ] `Size_Prop_Type` mapper (font-size, width, height, margins, padding)
- [ ] `Color_Prop_Type` mapper (color, background-color)
- [ ] `Dimensions_Prop_Type` mapper (margin, padding shorthand)
- [ ] `String_Prop_Type` mapper (display, position, flex-direction)

#### **Testing Framework**
- [ ] Create atomic widget validation tests
- [ ] Test actual JSON creation via `Widget_Builder`
- [ ] Verify visual rendering in Elementor editor

### **Phase 3: Complex Prop Types (Week 3)**
#### **Advanced Properties**
- [ ] `Box_Shadow_Prop_Type` mapper (box-shadow)
- [ ] `Border_Radius_Prop_Type` mapper (border-radius)
- [ ] `Background_Prop_Type` mapper (background)
- [ ] `Text_Shadow_Prop_Type` mapper (text-shadow)

#### **Integration Testing**
- [ ] Test complex property combinations
- [ ] Validate nested prop type structures
- [ ] Ensure proper atomic widget schema compliance

### **Phase 4: Complete Property Coverage (Week 4)**
#### **Remaining Properties**
- [ ] Border properties (border-width, border-style, border-color)
- [ ] Typography properties (font-weight, line-height, text-align)
- [ ] Layout properties (gap, align-items, flex)
- [ ] Effects properties (opacity, filter, transition)

#### **Quality Assurance**
- [ ] Comprehensive property testing
- [ ] Performance optimization
- [ ] Error handling and edge cases

### **Phase 5: Integration & Deployment (Week 5)**
#### **System Integration**
- [ ] Update REST API endpoints
- [ ] Integrate with existing HTML parser
- [ ] Update widget conversion service

#### **Final Testing**
- [ ] End-to-end conversion testing
- [ ] Visual rendering verification
- [ ] Performance benchmarking

---

## 🔧 **Technical Specifications**

### **Atomic Widget Integration Pattern**
```php
class Atomic_Widget_Service {
    public function create_widget_with_props( string $widget_type, array $props ): ?array {
        $builder = Widget_Builder::make( $widget_type );
        
        foreach ( $props as $prop_name => $prop_value ) {
            $atomic_prop = $this->convert_to_atomic_prop( $prop_name, $prop_value );
            if ( $atomic_prop ) {
                $builder->set_prop( $prop_name, $atomic_prop );
            }
        }
        
        return $builder->build();
    }
}
```

### **Prop Type Mapper Pattern**
```php
class Size_Prop_Type_Mapper {
    public function map_css_to_atomic( string $css_value ): ?array {
        $parsed = $this->parse_size_value( $css_value );
        
        // Use actual Size_Prop_Type structure
        return [
            '$$type' => 'size',
            'value' => [
                'size' => (float) $parsed['size'],
                'unit' => $parsed['unit']
            ]
        ];
    }
}
```

### **Widget Builder Integration**
```php
class Widget_JSON_Generator {
    public function generate_widget_json( array $element_data ): ?array {
        $builder = Widget_Builder::make( $element_data['widget_type'] );
        
        // Set props using atomic widget system
        foreach ( $element_data['props'] as $prop_name => $prop_value ) {
            $builder->set_prop( $prop_name, $prop_value );
        }
        
        // Generate validated JSON
        return $builder->build();
    }
}
```

---

## 🧪 **Testing Strategy**

### **Atomic Widget Validation Tests**
```php
class AtomicWidgetIntegrationTest extends TestCase {
    public function test_size_prop_type_integration() {
        $service = new Atomic_Widget_Service();
        $result = $service->create_widget_with_props( 'heading', [
            'font-size' => '16px'
        ]);
        
        // Verify actual atomic widget JSON structure
        $this->assertArrayHasKey( '$$type', $result['props']['font-size'] );
        $this->assertEquals( 'size', $result['props']['font-size']['$$type'] );
        
        // Verify passes atomic widget validation
        $this->assertTrue( $this->validate_with_atomic_widgets( $result ) );
    }
}
```

### **Visual Rendering Tests**
- Create test widgets in Elementor editor
- Verify properties visually render
- Test property changes update display
- Validate editor preview matches frontend

---

## 📁 **File Structure**

```
css-converter/
├── services/
│   └── atomic-widgets/
│       ├── atomic-widget-service.php
│       ├── widget-json-generator.php
│       ├── prop-type-validator.php
│       └── atomic-widget-orchestrator.php
├── convertors/
│   └── atomic-properties/
│       ├── contracts/
│       │   └── atomic-prop-mapper-interface.php
│       ├── prop-types/
│       │   ├── size-prop-type-mapper.php
│       │   ├── color-prop-type-mapper.php
│       │   ├── dimensions-prop-type-mapper.php
│       │   ├── box-shadow-prop-type-mapper.php
│       │   └── border-radius-prop-type-mapper.php
│       └── implementations/
│           ├── atomic-prop-mapper-factory.php
│           └── atomic-prop-mapper-registry.php
└── tests/
    └── phpunit/
        └── atomic-widgets/
            ├── AtomicWidgetIntegrationTest.php
            ├── PropTypeValidationTest.php
            └── VisualRenderingTest.php
```

---

## ⚠️ **Risk Assessment**

### **High Risk**
- **Atomic Widget API Changes**: Dependency on Elementor's internal APIs
- **Complex Prop Type Structures**: Nested prop types may be challenging
- **Performance Impact**: Additional atomic widget calls

### **Medium Risk**
- **Property Coverage**: Ensuring all 32+ properties are supported
- **Edge Case Handling**: Complex CSS values and combinations
- **Testing Complexity**: Validating visual rendering

### **Mitigation Strategies**
- **API Stability**: Use documented atomic widget interfaces
- **Incremental Development**: Build and test one prop type at a time
- **Comprehensive Testing**: Automated and manual validation

---

## 📊 **Success Metrics**

### **Technical Metrics**
- **100% Atomic Widget Integration**: All JSON created by atomic widgets
- **100% Visual Rendering**: All properties render in Elementor editor
- **100% Schema Compliance**: All JSON passes atomic widget validation
- **32+ Property Support**: Complete CSS property coverage

### **Quality Metrics**
- **Zero Fake JSON**: No pseudo-atomic structures
- **Performance**: < 100ms conversion time per property
- **Reliability**: 99.9% successful conversions
- **Maintainability**: Clean, documented, testable code

---

## 🚀 **Next Steps**

### **Immediate Actions (This Week)**
1. **✅ Complete Backup**: All existing CSS properties backed up
2. **🔄 Create Foundation**: Implement Phase 1 atomic widget integration
3. **🔄 Research Prop Types**: Catalog all atomic prop types
4. **🔄 Build Core Service**: Create `Atomic_Widget_Service`

### **Week 1 Deliverables**
- Functional atomic widget integration
- Core prop type mappers (Size, Color, String)
- Basic widget JSON generation
- Initial validation tests

---

## 📝 **Conclusion**

This PRD outlines a complete rebuild of the CSS properties system with proper atomic widget integration. The new architecture ensures all generated JSON is created by actual atomic widgets, passes validation, and renders visually in the Elementor editor.

**Key Success Factor**: Every property must be generated by the atomic widgets module, not by fake pseudo-atomic JSON creation.

---

**Document Version**: 1.0  
**Last Updated**: September 23, 2025  
**Next Review**: September 30, 2025
