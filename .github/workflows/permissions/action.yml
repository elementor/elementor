name: Permissions
description: Validate user permissions for the current repository & run the workflow.

inputs:
  ENVIRONMENT:
   required: true
   description: The environment to deploy to.
  DEPLOYMENT_PERMITTED:
   description: Comma separated list of users that are permitted to deploy.
   required: true
  DEPLOYMENT_REPOSITORY_OWNER:
   description: The repository owner to restrict.
   required: true

runs:
  using: "composite"
  steps:
    - shell: bash
      run: |
        echo "deployment repo owner: ${{ inputs.DEPLOYMENT_REPOSITORY_OWNER }}"
        echo "repository.owner.login: ${{ github.event.repository.owner.login }}"
        echo "actor: ${{ github.actor }}"
        echo "deployment permitted: ${{ inputs.DEPLOYMENT_PERMITTED }}"
        echo "environment: ${{ inputs.ENVIRONMENT }}"
        echo "github.ref: ${{ github.ref }}"
        echo "github.ref_name: ${{ github.ref_name }}"
        echo "github.ref_type: ${{ github.ref_type }}"
        echo "github.ref_source: ${{ github.ref_source }}"
        echo "github.ref_source_repository: ${{ github.ref_source_repository }}"
        echo "github.ref_source_repository_owner: ${{ github.ref_source_repository_owner }}"
        echo "github.ref_source_repository_owner_name: ${{ github.ref_source_repository_owner_name }}"
        echo "github.ref_source_repository_owner_email: ${{ github.ref_source_repository_owner_email }}"

        
        if [[ "${{ inputs.DEPLOYMENT_REPOSITORY_OWNER }}" != "${{ github.event.repository.owner.login }}" ]];then
          echo "Pass validation outside of main repo owner"
          exit 0
        fi
        if [[ "${{ inputs.ENVIRONMENT }}" == "dev" ]];then
          echo "Pass validation in the development environment"
          exit 0
        fi
        if ! echo "${{ inputs.DEPLOYMENT_PERMITTED }}" | grep -iq "${{ github.actor }}"; then
         echo "::error::No deployment permissions have been granted to the user : ${{ github.actor }}"
         exit 1
        fi
