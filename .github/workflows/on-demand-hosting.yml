name: On Demand Hosting
description: On Demand Hosting

on: 
  workflow_dispatch:
    inputs:
      SITE_URL:
        description: 'The site URL'
        required: true


permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  build-plugin:
    name: Build plugin
    uses: ./.github/workflows/build.yml

  deploy-to-hosting:
    name: Deploy to On Demand Hosting
    runs-on: ubuntu-22.04
    needs: [build-plugin]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-plugin.outputs.artifact_name }}
          path: ./build
      
      - name: Upload to SFTP server
        run: |
          echo "Deploying to site: https://fnfwlpbk.stg.elementor.cool"
          echo "Built artifact downloaded to ./build"
          
          # Package the artifact
          cd ./build
          zip -r ../elementor-plugin.zip .
          cd ..
          
          # Install sshpass for SFTP authentication
          sudo apt-get update && sudo apt-get install -y sshpass
          
          # Upload to SFTP server
          echo "Uploading elementor-plugin.zip to SFTP server..."
          sshpass -p 'fxkVvDNT6gi74T91' sftp -P 32022 -o StrictHostKeyChecking=no lSVllGgK@sftp.stg.elementor.cool << EOF
          cd /html/wp-content/uploads
          put elementor-plugin.zip
          quit
          EOF
          
          echo "✅ Plugin successfully uploaded to SFTP server"
          echo "📁 File: /html/wp-content/uploads/elementor-plugin.zip"
          echo "🖥️  Host: sftp.stg.elementor.cool:32022"
          
          # Install plugin via WP-CLI API
          echo "Installing plugin on site: https://fnfwlpbk.stg.elementor.cool"
          PLUGIN_URL="https://fnfwlpbk.stg.elementor.cool/wp-content/uploads/elementor-plugin.zip"
          
          API_RESPONSE=$(curl -X 'POST' \
            'https://control-api.stg.elementor.link/v2/wp-cli/151508' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'CF-Access-Client-Id: ${{ secrets.CF_CLIENT_ID }}' \
            -H 'CF-Access-Client-Secret: ${{ secrets.CF_CLIENT_SECRET }}' \
            -d "{
              \"command\": [
                \"plugin\", \"install\", \"$PLUGIN_URL\"
              ]
            }" -w "%{http_code}" -s)
          
          HTTP_CODE="${API_RESPONSE: -3}"
          RESPONSE_BODY="${API_RESPONSE%???}"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Plugin successfully installed via WP-CLI API"
            echo "📦 Plugin URL: $PLUGIN_URL"
            echo "🚀 Deployment completed successfully!"
          else
            echo "❌ Failed to install plugin via WP-CLI API"
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
