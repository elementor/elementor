name: Verify Tickets Merged to Branch

on:
  workflow_dispatch:
    inputs:
      tickets_list:
        description: 'Comma-separated tickets (e.g., ED-20358, ED-21219) - leave empty to use Jira version'
        required: false
        type: string
      jira_version:
        description: 'Or provide Jira version (e.g., v3.33.1, 3.33) - will fetch tickets from Jira'
        required: false
        type: string
      target_branch:
        description: 'Target branch to check (e.g., 3.33)'
        required: true
        type: string
      base_branch:
        description: 'Base branch for comparison (e.g., main)'
        required: false
        default: 'main'
        type: string

permissions:
  contents: read

jobs:
  verify-tickets:
    name: Verify Tickets Merged
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: git fetch --all

      - name: Install Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Verify Tickets
        id: verify
        env:
          TICKETS_LIST: ${{ github.event.inputs.tickets_list }}
          JIRA_VERSION: ${{ github.event.inputs.jira_version }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          BASE_BRANCH: ${{ github.event.inputs.base_branch }}
          JIRA_CLIENT_ID: ${{ secrets.JIRA_CLIENT_ID }}
          JIRA_CLIENT_SECRET: ${{ secrets.JIRA_CLIENT_SECRET }}
          JIRA_CLOUD_INSTANCE_BASE_URL: ${{ secrets.JIRA_CLOUD_INSTANCE_BASE_URL }}
        run: node .github/scripts/verify-jira-version-merged.js

      - name: Create Summary
        if: always()
        run: |
          echo "# Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tickets:** ${{ github.event.inputs.tickets_list }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.event.inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base:** ${{ github.event.inputs.base_branch }}" >> $GITHUB_STEP_SUMMARY
