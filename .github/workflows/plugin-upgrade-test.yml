name: Verify Jira Version Merged to Branch

on:
  workflow_dispatch:
    inputs:
      jira_version:
        description: 'Jira Version (e.g., v3.33.1)'
        required: true
        type: string
      target_branch:
        description: 'Target branch to check (e.g., 3.33)'
        required: true
        type: string
      base_branch:
        description: 'Base branch for comparison (e.g., main)'
        required: false
        default: 'main'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  verify-version:
    name: Verify Jira Version
    runs-on: ubuntu-latest
    outputs:
      missing_tickets: ${{ steps.verify.outputs.missing_tickets }}
      verification_result: ${{ steps.verify.outputs.result }}
      total_tickets: ${{ steps.verify.outputs.total_tickets }}
      merged_tickets: ${{ steps.verify.outputs.merged_tickets }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches and tags
        run: git fetch --all --tags

      - name: Install Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Verify Jira Version in Branch
        id: verify
        env:
          JIRA_VERSION: ${{ github.event.inputs.jira_version }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          BASE_BRANCH: ${{ github.event.inputs.base_branch }}
          JIRA_CLIENT_ID: ${{ secrets.JIRA_CLIENT_ID }}
          JIRA_CLIENT_SECRET: ${{ secrets.JIRA_CLIENT_SECRET }}
          JIRA_CLOUD_INSTANCE_BASE_URL: ${{ secrets.JIRA_CLOUD_INSTANCE_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node .github/scripts/verify-jira-version-merged.js

      - name: Create Job Summary
        if: always()
        run: |
          echo "# Jira Version Merge Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.jira_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${{ github.event.inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base Branch:** ${{ github.event.inputs.base_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tickets:** ${{ steps.verify.outputs.total_tickets }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged Tickets:** ${{ steps.verify.outputs.merged_tickets }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify.outputs.result }}" = "success" ]; then
            echo "✅ **Result:** All tickets are merged to the branch!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Result:** Some tickets are missing from the branch" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Missing Tickets:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.verify.outputs.missing_tickets }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tickets missing
        if: steps.verify.outputs.result != 'success'
        run: |
          echo "❌ Verification failed: Some tickets from ${{ github.event.inputs.jira_version }} are not merged to ${{ github.event.inputs.target_branch }}"
          exit 1

