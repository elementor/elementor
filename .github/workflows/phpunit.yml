name: PHPUnit

permissions:
  contents: read

on:
  schedule:
    - cron: '30 08 * * 0,1,2,3,4,5'
  workflow_dispatch:
  pull_request:
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.github/config.json'
      - 'bin/**'
      - '.gitignore'
      - 'docs/**'
  merge_group:

# This allows a subsequently queued workflow run to interrupt previous runs
concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  file-diff:
    runs-on: ubuntu-latest
    name: File Diff
    if: startsWith( github.repository, 'elementor/' )
    outputs:
      php_diff: ${{ steps.php_diff_files.outputs.diff }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Check PHP files diff
        id: php_diff_files
        uses: technote-space/get-diff-action@v6
        with:
          PATTERNS: |
            **/*.php
            **/*.twig
            composer.+(json|lock)
            .github/**/*.yml
            install-wp-tests.sh

  test_pr_group:
    uses: ./.github/workflows/phpunit-runner.yml
    needs: ['file-diff']
    if: ${{ (github.event_name == 'pull_request' || github.event_name == 'merge_group') && (github.event.pull_request.title == null || needs.file-diff.outputs.php_diff) }}
    with:
      job_name: PHPUnit (PR/Merge)
      wordpress_versions: '["latest", "6.8", "6.7"]'
      php_versions: '["7.4", "8.0", "8.1", "8.2", "8.3"]'

  test_schedule:
    uses: ./.github/workflows/phpunit-runner.yml
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    with:
      job_name: PHPUnit (Nightly)
      wordpress_versions: '["latest", "6.8", "6.7", "nightly"]'
      php_versions: '["7.4", "8.0", "8.1", "8.2", "8.3", "8.4"]'

  test-result:
    needs: [test_pr_group, test_schedule]
    if: ${{ always() }}
    runs-on: ubuntu-22.04
    name: PHPUnit - Test Results
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Check stable test status
        run: echo "Stable Test status is - ${{ needs.test_pr_group.result }}"
      - name: Check nightly test status
        run: echo "Nightly Test status is - ${{ needs.test_schedule.result }}"
      - name: Send slack message
        if: ${{ needs.test_schedule.result == 'failure' && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') }}
        uses: ./.github/workflows/post-to-slack
        with:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
          SLACK_TAG_CHANNELS: ${{ secrets.TEST_AUTOMATION_RESULTS }}
          PAYLOAD: |
            {
              "text": "Elementor Core: Scheduled PHPUnit tests failed - ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Elementor Core: Scheduled PHPUnit tests failed - ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Scheduled PHPUnit tests failed"
                  }
                }
              ]
            }
      - name: Final Test Status Check
        if: ${{ (needs.test_pr_group.result != 'success' && needs.test_pr_group.result != 'skipped') || (needs.test_schedule.result != 'success' && needs.test_schedule.result != 'skipped') }}
        run: exit 1
