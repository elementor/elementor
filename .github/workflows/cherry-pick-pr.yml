name: Cherry Pick Merged PR

on:
  pull_request:
    types:
      - closed
    #branches:
    # - main # Or your main development branch, e.g., 'master'

jobs:
  cherry-pick:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for cherry-pick

      - name: Extract Cherry-Pick Labels
        id: get_labels
        run: |
          LABELS_JSON='${{ toJSON(github.event.pull_request.labels) }}'
          echo "Raw Labels JSON: $LABELS_JSON"
          CP_LABELS=""
          for label in $(echo "$LABELS_JSON" | jq -r '.[].name'); do
            echo "Processing label: $label"
            if [[ "$label" =~ ^cp_[0-9]+\.[0-9]+$ ]]; then
              TARGET_BRANCH=$(echo "$label" | sed 's/^cp_//')
              CP_LABELS+=" $TARGET_BRANCH"
              echo "Identified target branch: $TARGET_BRANCH"
            fi
          done
          echo "Final cherry_pick_branches=${CP_LABELS}" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Cherry-Pick and Create PRs
        if: steps.get_labels.outputs.cherry_pick_branches != ''
        env:
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MERGE_COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          ORIGINAL_PR_TITLE="${{ github.event.pull_request.title }}"
          ORIGINAL_PR_URL="${{ github.event.pull_request.html_url }}"
      
          for TARGET_BRANCH in ${{ steps.get_labels.outputs.cherry_pick_branches }}; do
            echo "Attempting to cherry-pick to branch: $TARGET_BRANCH"
            if [ -z "$TARGET_BRANCH" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
            # Create a new branch for cherry-pick
            CHERRY_PICK_BRANCH="cherry-pick-pr-${PR_NUMBER}-${TARGET_BRANCH}"
            git checkout -b "$CHERRY_PICK_BRANCH" "$TARGET_BRANCH" || { echo "::error::Branch $TARGET_BRANCH does not exist or cannot be checked out."; exit 1; }

            # Cherry-pick the commit
            if git cherry-pick -m 1 "$MERGE_COMMIT_SHA"; then
              echo "Successfully cherry-picked $MERGE_COMMIT_SHA to $CHERRY_PICK_BRANCH"
              git push origin "$CHERRY_PICK_BRANCH"

              # Create Pull Request
              PR_TITLE="Cherry-pick PR #${PR_NUMBER} to ${TARGET_BRANCH}: ${ORIGINAL_PR_TITLE}"
              PR_BODY="This is an automated cherry-pick of PR #${PR_NUMBER} (${ORIGINAL_PR_URL}) to the \`${TARGET_BRANCH}\` branch."
              
              gh pr create --base "$TARGET_BRANCH" --head "$CHERRY_PICK_BRANCH" --title "$PR_TITLE" --body "$PR_BODY" || { echo "::error::Failed to create pull request for $TARGET_BRANCH."; exit 1; }
              echo "Created PR for $TARGET_BRANCH"

            else
              echo "::error::Cherry-pick failed for branch $TARGET_BRANCH. Manual intervention required."
              git cherry-pick --abort
              # Optionally, you could notify here, e.g., using GitHub comments API
            fi
          done
        shell: bash 